<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pit Lane Kart Manager</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  background:#111;
  color:#fff;
  font-family:Arial, sans-serif;
  padding:10px;
}

section { margin-bottom:20px; }

button, select, input {
  padding:6px;
  font-size:14px;
  margin-top:4px;
}

.team-box, .kart {
  width:95px;
  height:95px;
  border-radius:6px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  font-size:12px;
  border:2px solid #000;
  text-align:center;
}

.blue {background:#3498db;}
.red {background:#e74c3c;}
.orange {background:#e67e22;}
.yellow {background:#f1c40f;color:#000;}
.green {background:#2ecc71;}
.purple {background:#9b59b6;}

#pits {
  display:flex;
  gap:25px;
  flex-wrap:wrap;
}

.row {
  display:flex;
  gap:10px;
  align-items:flex-start;
}

.kart-column {
  display:flex;
  flex-direction:column;
  gap:6px;
}

.small { font-size:10px; }

table {
  border-collapse:collapse;
  width:100%;
  margin-bottom:15px;
}

th, td {
  border:1px solid #444;
  padding:4px;
  font-size:12px;
  text-align:center;
}

th { background:#222; }

/* ðŸ”’ Undo / Redo fixed controls */
#historyControls {
  position:fixed;
  top:10px;
  right:10px;
  z-index:9999;
  display:flex;
  gap:6px;
}
</style>
</head>

<body>

<div id="historyControls">
  <button onclick="stepBack()">â¬…</button>
  <button onclick="stepForward()">âž¡</button>
</div>

<h2>Setup</h2>
<section>
  Teams:
  <input id="teamCount" type="number" min="1" value="3">
  Rows:
  <input id="rowCount" type="number" min="1" value="2">
  Karts per row:
  <input id="kartsPerRow" type="number" min="1" value="3">
  <br>
  <button onclick="buildTeamInputs()">Next</button>
</section>

<section id="teamSetup"></section>
<button onclick="initialize()">Initialize</button>

<hr>

<h2>Teams (on track)</h2>
<section id="teams"></section>

<h2>Pit Lane</h2>
<section id="pits"></section>

<h2>Reserve Row</h2>
<section id="reserve"></section>

<h2>Team Kart History</h2>
<section id="history"></section>

<script>
const COLORS = ["blue","red","orange","yellow","green","purple"];

let teams = [];
let rows = [];
let reserveRow = [];
let pitCounter = 1;
let reserveCounter = 1;

/* ---------- UNDO / REDO ---------- */
let timeline = [];
let timelineIndex = -1;

function saveState() {
  timeline = timeline.slice(0, timelineIndex + 1);
  timeline.push(JSON.stringify({teams, rows, reserveRow, pitCounter, reserveCounter}));
  timelineIndex++;
}

function loadState(index) {
  const state = JSON.parse(timeline[index]);
  teams = state.teams;
  rows = state.rows;
  reserveRow = state.reserveRow;
  pitCounter = state.pitCounter;
  reserveCounter = state.reserveCounter;
  render();
}

function stepBack() {
  if (timelineIndex > 0) {
    timelineIndex--;
    loadState(timelineIndex);
  }
}

function stepForward() {
  if (timelineIndex < timeline.length - 1) {
    timelineIndex++;
    loadState(timelineIndex);
  }
}

/* ---------- SETUP ---------- */
function buildTeamInputs() {
  const count = Number(teamCount.value);
  const el = document.getElementById("teamSetup");
  el.innerHTML = "<h3>Teams</h3>";

  for (let i=0;i<count;i++) {
    el.innerHTML += `
      <div>
        Team name:
        <input id="tname${i}" value="Team ${i+1}">
        Team kart number:
        <input id="tnumber${i}" value="${i+1}">
      </div>`;
  }
}

function initialize() {
  teams = [];
  rows = [];
  reserveRow = [];
  pitCounter = 1;
  reserveCounter = 1;
  timeline = [];
  timelineIndex = -1;

  const tCount = Number(teamCount.value);
  const rCount = Number(rowCount.value);
  const kCount = Number(kartsPerRow.value);

  for (let i=0;i<tCount;i++) {
    const kartId = `K${i+1}`;
    teams.push({
      name: document.getElementById(`tname${i}`).value,
      teamNumber: document.getElementById(`tnumber${i}`).value,
      kartId,
      color:"blue",
      history:[{kartId,color:"blue"}]
    });
  }

  for (let r=0;r<rCount;r++) {
    const row=[];
    for (let k=0;k<kCount;k++) {
      row.push({kartId:`P${pitCounter++}`,color:"blue"});
    }
    rows.push(row);
  }

  saveState();
  render();
}

/* ---------- HELPERS ---------- */
function colorSelect(current, cb) {
  const s=document.createElement("select");
  COLORS.forEach(c=>{
    const o=document.createElement("option");
    o.value=c;
    o.textContent=c;
    if(c===current) o.selected=true;
    s.appendChild(o);
  });
  s.onchange=e=>{cb(e.target.value); saveState();};
  return s;
}

/* ---------- RENDER ---------- */
function render() {
  renderTeams();
  renderPits();
  renderReserve();
  renderHistory();
}

function renderTeams() {
  const el=document.getElementById("teams");
  el.innerHTML="";
  teams.forEach(t=>{
    const d=document.createElement("div");
    d.className=`team-box ${t.color}`;
    d.innerHTML=`
      <b>${t.name}</b>
      <div class="small">Team kart ${t.teamNumber}</div>
      <div class="small">${t.kartId}</div>`;
    d.appendChild(colorSelect(t.color,c=>t.color=c));
    el.appendChild(d);
  });
}

function renderKart(kart, swapFn) {
  const d=document.createElement("div");
  d.className=`kart ${kart.color}`;
  d.innerHTML=`<b>${kart.kartId}</b>`;
  d.appendChild(colorSelect(kart.color,c=>kart.color=c));
  const b=document.createElement("button");
  b.textContent="Swap";
  b.onclick=()=>{swapFn(); saveState();};
  d.appendChild(b);
  return d;
}

function renderPits() {
  const el=document.getElementById("pits");
  el.innerHTML="";

  rows.forEach((row,ri)=>{
    const rowDiv=document.createElement("div");
    rowDiv.className="row";

    const col=document.createElement("div");
    col.className="kart-column";

    row.forEach((k,ki)=>{
      col.appendChild(renderKart(k,()=>swapKart({type:"pit",ri,ki})));
    });

    const teamSel=document.createElement("select");
    teams.forEach((t,i)=>{
      const o=document.createElement("option");
      o.value=i;
      o.textContent=`Team ${t.teamNumber}`;
      teamSel.appendChild(o);
    });

    const plus=document.createElement("button");
    plus.textContent="+";
    plus.onclick=()=>{pitStop(ri,Number(teamSel.value)); saveState();};

    rowDiv.appendChild(col);
    rowDiv.appendChild(teamSel);
    rowDiv.appendChild(plus);
    el.appendChild(rowDiv);
  });
}

function renderReserve() {
  const el=document.getElementById("reserve");
  el.innerHTML="";

  const col=document.createElement("div");
  col.className="kart-column";

  reserveRow.forEach((k,ki)=>{
    col.appendChild(renderKart(k,()=>swapKart({type:"reserve",ki})));
  });

  const plus=document.createElement("button");
  plus.textContent="+";
  plus.onclick=()=>{
    reserveRow.push({kartId:`R${reserveCounter++}`,color:"blue"});
    saveState();
    render();
  };

  el.appendChild(col);
  el.appendChild(plus);
}

function renderHistory() {
  const el=document.getElementById("history");
  el.innerHTML="";
  teams.forEach(t=>{
    const table=document.createElement("table");
    table.innerHTML=`<tr><th>#</th><th>Kart</th><th>Color</th></tr>`;
    t.history.forEach((h,i)=>{
      table.innerHTML+=`<tr><td>${i+1}</td><td>${h.kartId}</td><td>${h.color}</td></tr>`;
    });
    el.appendChild(table);
  });
}

/* ---------- LOGIC ---------- */
function pitStop(rowIndex, teamIndex) {
  const row = rows[rowIndex];
  const team = teams[teamIndex];

  const first = row.shift();
  row.push({kartId:team.kartId,color:team.color});

  team.kartId = first.kartId;
  team.color = first.color;
  team.history.push({kartId:team.kartId,color:team.color});

  render();
}

function swapKart(from) {
  const all = [];

  rows.forEach((r,ri)=>r.forEach((k,ki)=>all.push({type:"pit",ri,ki,k})));
  reserveRow.forEach((k,ki)=>all.push({type:"reserve",ki,k}));

  const list = all.map((o,i)=>`${i}: ${o.k.kartId}`).join("\n");
  const sel = Number(prompt("Swap with:\n"+list));
  if(isNaN(sel) || !all[sel]) return;

  const a = from.type==="pit" ? rows[from.ri][from.ki] : reserveRow[from.ki];
  const b = all[sel].type==="pit"
    ? rows[all[sel].ri][all[sel].ki]
    : reserveRow[all[sel].ki];

  const temp = {...a};
  Object.assign(a,b);
  Object.assign(b,temp);

  render();
}
</script>

</body>
</html>
