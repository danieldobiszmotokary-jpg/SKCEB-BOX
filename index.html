<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pit Lane Kart Manager</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {background:#111;color:#fff;font-family:Arial;padding:10px;}
section {margin-bottom:20px;}
button, select, input {padding:6px;font-size:14px;margin:4px 0;}
.team-box, .kart {
  width:90px;height:90px;border-radius:6px;
  display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  font-size:12px;border:2px solid #000;text-align:center;
}
.blue{background:#3498db;} .red{background:#e74c3c;}
.orange{background:#e67e22;} .yellow{background:#f1c40f;color:#000;}
.green{background:#2ecc71;} .purple{background:#9b59b6;}

#pits{display:flex;gap:20px;flex-wrap:wrap;}
.row{display:flex;gap:12px;}
.kart-column{display:flex;flex-direction:column;gap:6px;}
.small{font-size:10px;}

table{border-collapse:collapse;width:100%;}
th,td{border:1px solid #444;padding:4px 6px;font-size:12px;text-align:center;}
th{background:#222;}
</style>
</head>

<body>

<h2>Setup</h2>
<section>
Teams <input id="teamCount" type="number" value="3">
Rows <input id="rowCount" type="number" value="2">
Karts/row <input id="kartsPerRow" type="number" value="3">
Reserve <input id="reserveCount" type="number" value="2">
<br>
<button onclick="buildTeamInputs()">Next</button>
</section>

<section id="teamSetup"></section>
<section><button onclick="initialize()">Initialize</button></section>

<hr>

<h2>Teams</h2>
<section id="teams"></section>

<h2>Pit Lane</h2>
<section id="pits"></section>

<h2>History</h2>
<section id="history"></section>

<script>
const COLORS=["blue","red","orange","yellow","green","purple"];
let teams=[], rows=[], reserve=[], pCounter=1, rCounter=1;

function buildTeamInputs(){
  teamSetup.innerHTML="";
  for(let i=0;i<teamCount.value;i++){
    teamSetup.innerHTML+=`
      <div>
        Name <input id="n${i}" value="Team ${i+1}">
        Number <input id="k${i}" value="${i+1}">
      </div>`;
  }
}

function initialize(){
  teams=[]; rows=[]; reserve=[]; pCounter=1; rCounter=1;

  for(let i=0;i<teamCount.value;i++){
    const id=`K${i+1}`;
    teams.push({name:n${i}.value, number:k${i}.value, kartId:id, color:"blue",
      history:[{kartId:id,color:"blue"}]});
  }

  for(let r=0;r<rowCount.value;r++){
    const row=[];
    for(let k=0;k<kartsPerRow.value;k++){
      row.push({kartId:`P${pCounter++}`,color:"blue"});
    }
    rows.push(row);
  }

  for(let i=0;i<reserveCount.value;i++){
    reserve.push({kartId:`R${rCounter++}`,color:"blue"});
  }
  render();
}

function colorSelect(val,cb){
  const s=document.createElement("select");
  COLORS.forEach(c=>{
    const o=document.createElement("option");
    o.value=c;o.textContent=c;if(c===val)o.selected=true;
    s.appendChild(o);
  });
  s.onchange=e=>cb(e.target.value);
  return s;
}

function render(){
  renderTeams(); renderPits(); renderHistory();
}

function renderTeams(){
  teamsEl.innerHTML="";
  teams.forEach((t,i)=>{
    const d=document.createElement("div");
    d.className=`team-box ${t.color}`;
    d.innerHTML=`<b>${t.name}</b><div class="small">#${t.number}</div><div>${t.kartId}</div>`;
    d.appendChild(colorSelect(t.color,c=>{t.color=c;render();}));
    teamsEl.appendChild(d);
  });
}

function renderPits(){
  pits.innerHTML="";
  const allRows=[...rows,[...reserve]];
  allRows.forEach((row,ri)=>{
    const isReserve=ri===rows.length;
    const rowDiv=document.createElement("div"); rowDiv.className="row";
    const col=document.createElement("div"); col.className="kart-column";

    row.forEach((k,ki)=>{
      const d=document.createElement("div");
      d.className=`kart ${k.color}`;
      d.innerHTML=`${k.kartId}`;
      d.appendChild(colorSelect(k.color,c=>{k.color=c;render();}));

      const swapSel=document.createElement("select");
      [...rows.flat(),...reserve].forEach(o=>{
        if(o!==k){
          const opt=document.createElement("option");
          opt.value=o.kartId; opt.textContent=o.kartId;
          swapSel.appendChild(opt);
        }
      });

      const btn=document.createElement("button");
      btn.textContent="Swap";
      btn.onclick=()=>swap(k,swapSel.value);

      d.appendChild(swapSel); d.appendChild(btn);
      col.appendChild(d);
    });

    const addBtn=document.createElement("button");
    addBtn.textContent="+";
    addBtn.onclick=()=>{ row.push({kartId:isReserve?`R${rCounter++}`:`P${pCounter++}`,color:"blue"}); render(); };

    rowDiv.appendChild(col);
    rowDiv.appendChild(addBtn);
    pits.appendChild(rowDiv);
  });
}

function swap(a,id){
  const all=[...rows.flat(),...reserve];
  const b=all.find(k=>k.kartId===id);
  [a.kartId,b.kartId]=[b.kartId,a.kartId];
  [a.color,b.color]=[b.color,a.color];
  render();
}

function pitStop(r,t){
  const row=rows[r], team=teams[t];
  const taken=row.shift();
  row.push({kartId:team.kartId,color:team.color});
  team.kartId=taken.kartId;
  team.color=taken.color;
  team.history.push({kartId:taken.kartId,color:taken.color});
  render();
}

function renderHistory(){
  history.innerHTML="";
  teams.forEach(t=>{
    let h=`<table><tr><th colspan="3">${t.name}</th></tr>`;
    h+=`<tr><th>#</th><th>Kart</th><th>Color</th></tr>`;
    t.history.forEach((s,i)=>h+=`<tr><td>${i+1}</td><td>${s.kartId}</td><td>${s.color}</td></tr>`);
    history.innerHTML+=h+"</table>";
  });
}
</script>

</body>
</html>
